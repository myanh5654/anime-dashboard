<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Anime Dashboard</title>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
   
    <style>
        body { font-family: sans-serif; background: #f4f4f4; padding: 20px; }
        .container { max-width: 1200px; margin: auto; }
        h1, h2 { color: #333; }
        .feature { background: #fff; padding: 20px; margin-bottom: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .chart { min-height: 400px; width: 100%; }
        .filters { margin-bottom: 20px; }
        .filters select, .filters button, .filters input { padding: 10px; font-size: 14px; }
        .content-layout { display: flex; gap: 20px; }
        .chart-container { flex: 1; }
        .grid-container { flex: 1; }
        .anime-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
            padding-bottom: 250px;
        }
        .anime-card { position: relative; cursor: pointer; }
        .anime-card img {
            width: 100%;
            height: 190px;
            object-fit: cover;
            border-radius: 5px;
            background: #eee;
        }
        .anime-title {
            font-size: 0.9em;
            font-weight: bold;
            margin-top: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .info-tooltip {
            display: none;
            position: absolute;
            top: 10px;
            left: 0;
            width: 250px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 10px;
            border-radius: 5px;
            z-index: 10;
            font-size: 0.9em;
            pointer-events: none;
        }
        .anime-card:hover .info-tooltip { display: block; }
        #loading { display: none; font-size: 1.5em; text-align: center; padding: 20px; }
        /* (THÃŠM Má»šI) CSS cho Bá»™ lá»c F2 */
        .f2-filters {
             display: grid;
             /* 3fr cho genres, 1fr cho cÃ¡c cá»™t cÃ²n láº¡i */
             grid-template-columns: 3fr 1fr 1fr 1fr 1fr;
             gap: 15px;
             align-items: start;
        }
        .genre-checkboxes {
            max-height: 100px; /* Giá»›i háº¡n chiá»u cao */
            overflow-y: auto; /* ThÃªm thanh cuá»™n */
            border: 1px solid #ccc;
            padding: 10px;
        }
        .genre-checkboxes label {
            display: block; /* Má»—i checkbox 1 hÃ ng */
            margin-right: 15px;
        }
        /* (THÃŠM Má»šI) CSS cho Bá»™ lá»c F3 */
        .f3-filters {
            display: flex;
            gap: 10px; /* Khoáº£ng cÃ¡ch giá»¯a cÃ¡c dropdown */
        }
        .f3-filters select {
            flex: 1; /* Cho 3 dropdown rá»™ng báº±ng nhau */
            padding: 10px;
            font-size: 14px;
        }
        .f3-genre-checkboxes label {
            display: block;
            margin-right: 15px;
        }
        .loading { display: none; }
    </style>
</head>
<body>


    <div class="container">
        <h1>Anime Suisen</h1>
        <div id="loading">Äang táº£i...</div>


        <div class="feature" id="feature-1">
            <h2>Top 5 Studio theo Thá»ƒ loáº¡i</h2>
            <div class="filters">
                <select id="genre-filter" style="width: 300px;">
                    <option value="">-- Lá»c theo Thá»ƒ loáº¡i --</option>
                </select>
                <button id="filter-button">Lá»c</button>
            </div>
           
            <div class="content-layout">
                <div class="chart-container">
                    <div id="chart-studios" class="chart"></div>
                </div>
                <div class="grid-container">
                    <h3>Anime ná»•i báº­t tá»« cÃ¡c Studio nÃ y</h3>
                    <div id="grid-anime" class="anime-grid"></div>
                </div>
            </div>
        </div>
        </div> <div class="feature" id="feature-2">
            <h2>TÃ¬m Anime theo Sá»Ÿ thÃ­ch</h2>
            <div class="filters f2-filters">
                <div class="genre-checkboxes" id="f2-genre-checkboxes">
                    </div>
                <select id="f2-year-filter"><option value="">-- NÄƒm --</option></select>
                <select id="f2-studio-filter"><option value="">-- Studio --</option></select>
                <select id="f2-episodes-filter">
                    <option value="">-- Sá»‘ táº­p --</option>
                    <option value="1">Movie (1 táº­p)</option>
                    <option value="12">Series ngáº¯n (<= 12)</option>
                    <option value="26">Series vá»«a (<= 26)</option>
                </select>
                <select id="f2-rating-filter">
                    <option value="">-- Rating --</option>
                    <option value="9">TrÃªn 9.0</option>
                    <option value="8">TrÃªn 8.0</option>
                    <option value="7">TrÃªn 7.0</option>
                </select>
            </div>
            <button id="f2-filter-button" style="padding: 10px 20px;">TÃ¬m</button>
            
            <div class="loading" id="loading-f2" style="margin-top: 20px;">Äang tÃ¬m...</div>
            <div id="f2-grid-anime" class="anime-grid" style="margin-top: 20px;">
                </div>
        </div>
        <div class="feature" id="feature-3">
            <h2>So sÃ¡nh Xu hÆ°á»›ng Thá»ƒ loáº¡i (2010-2022)</h2>
            <p>Chá»n 1, 2, hoáº·c 3 thá»ƒ loáº¡i Ä‘á»ƒ so sÃ¡nh Ä‘iá»ƒm trung bÃ¬nh qua cÃ¡c nÄƒm.</p>
            
            <div class="filters f3-filters">
                <select id="f3-genre-1">
                    <option value="">-- Chá»n thá»ƒ loáº¡i 1 --</option>
                </select>
                <select id="f3-genre-2">
                    <option value="">-- Chá»n thá»ƒ loáº¡i 2 --</option>
                </select>
                <select id="f3-genre-3">
                    <option value="">-- Chá»n thá»ƒ loáº¡i 3 --</option>
                </select>
            </div>
            <button id="f3-compare-button" style="padding: 10px 20px;">So sÃ¡nh</button>
            
            <div class="loading" id="loading-f3" style="margin-top: 20px;">Äang táº£i biá»ƒu Ä‘á»“...</div>
            <div id="chart-trends" class="chart" style="margin-top: 20px;">
                </div>
        </div>
        <div class="feature" id="feature-4">
            <h2>Äá» xuáº¥t Anime TÆ°Æ¡ng tá»±</h2>
            <p>Nháº­p tÃªn anime báº¡n thÃ­ch Ä‘á»ƒ tÃ¬m cÃ¡c phim cÃ³ ná»™i dung, thá»ƒ loáº¡i, studio... tÆ°Æ¡ng Ä‘á»“ng.</p>
            
            <div class="filters">
                <input list="anime-titles" id="f4-anime-input" placeholder="Nháº­p tÃªn anime..." style="width: 400px;">
                <datalist id="anime-titles">
                    </datalist>
                <button id="f4-recommend-button">TÃ¬m gá»£i Ã½</button>
            </div>
            <div id="f4-source-container" style="display: none; margin-top: 20px;">
                </div>
            <div class="loading" id="loading-f4" style="margin-top: 20px; text-align: center;">
                Äang tÃ­nh toÃ¡n Ä‘iá»ƒm tÆ°Æ¡ng Ä‘á»“ng... (Viá»‡c nÃ y cÃ³ thá»ƒ máº¥t vÃ i giÃ¢y)
            </div>
            
            <div id="f4-content" style="display: none; margin-top: 20px;">
                <div class="chart-container">
                    <div id="chart-recommend" class="chart"></div>
                </div>
                <div class="grid-container" style="margin-top: 30px;">
                    <h3>Danh sÃ¡ch gá»£i Ã½ (sáº¯p xáº¿p theo Ä‘á»™ tÆ°Æ¡ng Ä‘á»“ng)</h3>
                    <div id="grid-recommend" class="anime-grid"></div>
                </div>
            </div>
        </div>
    </div>


    <script>
        const API_URL = "";
        // (Sá»¬A) Äá»•i láº¡i 2 biáº¿n khÃ³a
Â  Â  Â  Â  let isKitsuLoading = false; // KhÃ³a chung cho F1 vÃ  F4 (dÃ¹ng Kitsu)
Â  Â  Â  Â  let isJikanLoading = false; // KhÃ³a riÃªng cho F2 (dÃ¹ng Jikan)
        // (Sá»¬A) Äá»•i tÃªn cÃ¡c element F1 Ä‘á»ƒ chÃºng khÃ´ng bá»‹ trÃ¹ng
        const btnFilterF1 = document.getElementById('filter-button');
Â  Â  Â  Â  const selectGenreF1 = document.getElementById('genre-filter');
Â  Â  Â  Â  const loadingDivF1 = document.getElementById('loading');
Â  Â  Â  Â  const featureDivF1 = document.getElementById('feature-1');

Â  Â  Â  Â  // HÃ m sleep (chá»)
Â  Â  Â  Â  const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

Â  Â  Â  Â  document.addEventListener('DOMContentLoaded', () => {
Â  Â  Â  Â  Â  Â  // Khá»Ÿi táº¡o TÃ­nh nÄƒng 1
Â  Â  Â  Â  Â  Â  loadF1Genres(); // Äá»•i tÃªn hÃ m
Â  Â  Â  Â  Â  Â  btnFilterF1.addEventListener('click', loadFeature1); // Sá»­a tÃªn biáº¿n
Â  Â  Â  Â  Â  Â  loadFeature1();
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // (THÃŠM Má»šI) Khá»Ÿi táº¡o TÃ­nh nÄƒng 2
Â  Â  Â  Â  Â  Â  loadF2Filters();
Â  Â  Â  Â  Â  Â  document.getElementById('f2-filter-button').addEventListener('click', loadFeature2);
            // (THÃŠM Má»šI) Khá»Ÿi táº¡o TÃ­nh nÄƒng 3
            loadF3Filters();
            document.getElementById('f3-compare-button').addEventListener('click', loadFeature3);
            // (THÃŠM Má»šI) Khá»Ÿi táº¡o TÃ­nh nÄƒng 4
            loadF4Titles(); // Táº£i danh sÃ¡ch tÃªn anime cho Ã´ input
            document.getElementById('f4-recommend-button').addEventListener('click', loadFeature4);
Â  Â  Â  Â  });
        
Â  Â  Â  Â  // === CÃC HÃ€M CHO TÃNH NÄ‚NG 1 ===
Â  Â  Â  Â  // (Sá»¬A) Äá»•i tÃªn hÃ m
Â  Â  Â  Â  async function loadF1Genres() { 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const res = await fetch(`${API_URL}/api/genres`);
Â  Â  Â  Â  Â  Â  Â  Â  const genres = await res.json();
Â  Â  Â  Â  Â  Â  Â  Â  genres.forEach(g => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // (Sá»¬A) Sá»­a tÃªn biáº¿n
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  selectGenreF1.innerHTML += `<option value="${g}">${g}</option>`;
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  } catch (e) { console.error("Lá»—i táº£i F1 genres", e); }
Â  Â  Â  Â  }

Â  Â  Â  Â  async function loadFeature1() {
Â  Â  Â  Â  Â  Â  // (Sá»¬A) Sá»­a tÃªn biáº¿n
Â  Â  Â  Â  Â  Â  loadingDivF1.style.display = 'block';
Â  Â  Â  Â  Â  Â  featureDivF1.style.display = 'none';
Â  Â  Â  Â  Â  Â  const genre = selectGenreF1.value;

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const res = await fetch(`${API_URL}/api/top_studios?genre=${genre}`);
Â  Â  Â  Â  Â  Â  Â  Â  const data = await res.json();
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  drawStudioChart(data.chart_data);
Â  Â  Â  Â  Â  Â  Â  Â  // (Sá»¬A) Gá»i hÃ m dÃ¹ng chung, trá» vÃ o grid F1
Â  Â  Â  Â  Â  Â  Â  Â  drawAnimeGrid_F1_Kitsu(data.grid_data, 'grid-anime');
Â  Â  Â  Â  Â  Â  } catch(e) {
Â  Â  Â  Â  Â  Â  Â  Â  loadingDivF1.innerText = 'Lá»—i táº£i dá»¯ liá»‡u. HÃ£y thá»­ láº¡i.';
Â  Â  Â  Â  Â  Â  Â  Â  console.error(e);
Â  Â  Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  Â  Â  loadingDivF1.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  featureDivF1.style.display = 'block';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function drawStudioChart(studioData) {
Â  Â  Â  Â  Â  Â  // (Code hÃ m nÃ y giá»¯ nguyÃªn)
Â  Â  Â  Â  Â  Â  Highcharts.chart('chart-studios', {
Â  Â  Â  Â  Â  Â  Â  Â  chart: { type: 'bar' },
Â  Â  Â  Â  Â  Â  Â  Â  title: { text: 'Top 5 Studio theo Äiá»ƒm TB' },
Â  Â  Â  Â  Â  Â  Â  Â  xAxis: { categories: studioData.map(s => s.studios) },
Â  Â  Â  Â  Â  Â  Â  Â  yAxis: { min: 7, title: { text: 'Äiá»ƒm TB' } },
Â  Â  Â  Â  Â  Â  Â  Â  series: [{
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  name: 'Äiá»ƒm TB',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data: studioData.map(s => ({ y: s.avg_score, anime_count: s.anime_count }))
Â  Â  Â  Â  Â  Â  Â  Â  }],
Â  Â  Â  Â  Â  Â  Â  Â  tooltip: { pointFormat: 'Äiá»ƒm TB: <b>{point.y}</b> / {point.anime_count} anime' }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
        
        // === (THÃŠM Má»šI) CÃC HÃ€M CHO TÃNH NÄ‚NG 2 ===
        async function loadF2Filters() {
            try {
                const res = await fetch(`${API_URL}/api/all_filters`);
                const data = await res.json();
                
                // 1. Populate Genres (Checkbox)
                const genreBox = document.getElementById('f2-genre-checkboxes');
                data.genres.forEach(g => {
                    genreBox.innerHTML += `
                        <label>
                            <input type="checkbox" name="f2-genre" value="${g}"> ${g}
                        </label>`;
                });
                
                // 2. Populate Years
                const yearSelect = document.getElementById('f2-year-filter');
                data.years.forEach(y => {
                    yearSelect.innerHTML += `<option value="${y}">${y}</option>`;
                });
                
                // 3. Populate Studios
                const studioSelect = document.getElementById('f2-studio-filter');
                data.studios.forEach(s => {
                    studioSelect.innerHTML += `<option value="${s}">${s}</option>`;
                });
                
            } catch (e) { console.error("Lá»—i táº£i F2 filters", e); }
        }
        
        async function loadFeature2() {
            const loadingDiv = document.getElementById('loading-f2');
            loadingDiv.style.display = 'block';
            
            // 1. Láº¥y giÃ¡ trá»‹ (Checkbox cho "chá»n nhiá»u")
            const checkedGenres = document.querySelectorAll('#f2-genre-checkboxes input:checked');
            const genreList = Array.from(checkedGenres).map(cb => cb.value);
            
            // 2. XÃ¢y dá»±ng URL (Lesson 7)
            const params = new URLSearchParams();
            if (genreList.length > 0) {
                params.append('genres', genreList.join(',')); // "Action,Comedy"
            }
            if (document.getElementById('f2-year-filter').value) {
                params.append('year', document.getElementById('f2-year-filter').value);
            }
            if (document.getElementById('f2-studio-filter').value) {
                params.append('studio', document.getElementById('f2-studio-filter').value);
            }
            if (document.getElementById('f2-episodes-filter').value) {
                params.append('max_episodes', document.getElementById('f2-episodes-filter').value);
            }
            if (document.getElementById('f2-rating-filter').value) {
                params.append('min_score', document.getElementById('f2-rating-filter').value);
            }

            // 3. Gá»i API
            try {
                const res = await fetch(`${API_URL}/api/filter?${params.toString()}`);
                const data = await res.json();
                // TÃ¡i sá»­ dá»¥ng hÃ m váº½ Grid, nhÆ°ng trá» vÃ o div F2
                drawAnimeGrid_F2_Jikan(data, 'f2-grid-anime');
            } catch(e) {
                document.getElementById('f2-grid-anime').innerHTML = 'Lá»—i táº£i dá»¯ liá»‡u.';
            } finally {
                loadingDiv.style.display = 'none';
            }
        }
Â  Â  Â  Â  
        // === (THÃŠM Má»šI) CÃC HÃ€M CHO TÃNH NÄ‚NG 3 ===
        // (THAY THáº¾) HÃ€M NÃ€Y
// (THAY THáº¾) HÃ€M NÃ€Y
        async function loadF3Filters() {
            try {
                const res = await fetch(`${API_URL}/api/genres`);
                const genres = await res.json();
                
                // Láº¥y 3 select box
                const select1 = document.getElementById('f3-genre-1');
                const select2 = document.getElementById('f3-genre-2');
                const select3 = document.getElementById('f3-genre-3');
                
                // Náº¡p dá»¯ liá»‡u cho cáº£ 3
                genres.forEach(g => {
                    select1.innerHTML += `<option value="${g}">${g}</option>`;
                    select2.innerHTML += `<option value="${g}">${g}</option>`;
                    select3.innerHTML += `<option value="${g}">${g}</option>`;
                });
                
            } catch (e) { console.error("Lá»—i táº£i F3 filters", e); }
        }

// (THAY THáº¾) HÃ€M NÃ€Y
        async function loadFeature3() {
            const loadingDiv = document.getElementById('loading-f3');
            loadingDiv.style.display = 'block';
            
            // 1. Láº¥y giÃ¡ trá»‹ tá»« 3 dropdown
            const g1 = document.getElementById('f3-genre-1').value;
            const g2 = document.getElementById('f3-genre-2').value;
            const g3 = document.getElementById('f3-genre-3').value;

            // 2. Lá»c ra cÃ¡c giÃ¡ trá»‹ khÃ´ng rá»—ng vÃ  khÃ´ng trÃ¹ng láº·p
            // (ÄÃºng theo logic cá»§a báº¡n: "khÃ¡c nhau" vÃ  "váº«n cháº¡y náº¿u chá»‰ cÃ³ 1")
            const genresToCompare = [g1, g2, g3].filter(g => g !== ""); // Lá»c rá»—ng
            const uniqueGenres = [...new Set(genresToCompare)]; // Lá»c trÃ¹ng
            
            if (uniqueGenres.length === 0) {
                 alert('Báº¡n pháº£i chá»n Ã­t nháº¥t 1 thá»ƒ loáº¡i.');
                 loadingDiv.style.display = 'none';
                 return;
            }

            // 3. XÃ¢y dá»±ng URL
            const params = new URLSearchParams();
            params.append('genres', uniqueGenres.join(',')); // "Action,Comedy"

            // 4. Gá»i API
            try {
                const res = await fetch(`${API_URL}/api/genre_trends?${params.toString()}`);
                const data = await res.json();
                drawTrendChart(data); 
            } catch(e) {
                document.getElementById('chart-trends').innerHTML = 'Lá»—i táº£i dá»¯ liá»‡u.';
            } finally {
                loadingDiv.style.display = 'none';
            }
        }

        // (THÃŠM Má»šI) HÃ m váº½ Biá»ƒu Ä‘á»“ ÄÆ°á»ng
        function drawTrendChart(data) {
            Highcharts.chart('chart-trends', {
                chart: { type: 'line' },
                title: { text: 'So sÃ¡nh Äiá»ƒm TB cá»§a Thá»ƒ loáº¡i' },
                xAxis: {
                    categories: data.categories,
                    title: { text: 'NÄƒm (2010-2022)' }
                },
                yAxis: {
                    min: 7, // Báº¯t Ä‘áº§u tá»« 7 Ä‘iá»ƒm cho dá»… so sÃ¡nh
                    title: { text: 'Äiá»ƒm Trung BÃ¬nh' }
                },
                series: data.series, // ÄÃ¢y lÃ  máº£ng 1-3 chuá»—i (line)
                tooltip: {
                    shared: false // Ko hiá»ƒn thá»‹ tooltip chung cho táº¥t cáº£
                }
                // TÃ­nh nÄƒng "Báº­t/Táº¯t chuá»—i" (Rubric 4) Ä‘Ã£ Ä‘Æ°á»£c báº­t tá»± Ä‘á»™ng
            });
        }

// === (THÃŠM Má»šI) CÃC HÃ€M CHO TÃNH NÄ‚NG 4 ===
        async function loadF4Titles() {
            /** Táº£i táº¥t cáº£ tÃªn anime vÃ o datalist */
            try {
                const res = await fetch(`${API_URL}/api/all_titles`);
                const titles = await res.json();
                const datalist = document.getElementById('anime-titles');
                titles.forEach(title => {
                    datalist.innerHTML += `<option value="${title}"></option>`;
                });
            } catch (e) {
                console.error("Lá»—i táº£i danh sÃ¡ch anime cho F4", e);
            }
        }

        async function loadFeature4() {
Â  Â  Â  Â  Â  Â  /** Cháº¡y khi nháº¥n nÃºt 'TÃ¬m gá»£i Ã½' */
Â  Â  Â  Â  Â  Â  const loadingDiv = document.getElementById('loading-f4');
Â  Â  Â  Â  Â  Â  const contentDiv = document.getElementById('f4-content');
            // (THÃŠM Má»šI)
            const sourceContainer = document.getElementById('f4-source-container');
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  loadingDiv.style.display = 'block';
Â  Â  Â  Â  Â  Â  contentDiv.style.display = 'none'; // áº¨n káº¿t quáº£ cÅ©
            sourceContainer.style.display = 'none'; // (Sá»¬A) áº¨n container anime gá»‘c
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const title = document.getElementById('f4-anime-input').value;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if (!title) {
Â  Â  Â  Â  Â  Â  Â  Â  alert('Vui lÃ²ng nháº­p hoáº·c chá»n má»™t tÃªn anime tá»« danh sÃ¡ch.');
Â  Â  Â  Â  Â  Â  Â  Â  loadingDiv.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const res = await fetch(`${API_URL}/api/recommend?title=${encodeURIComponent(title)}`);
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  if (!res.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const err_data = await res.json();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(err_data.error || 'Lá»—i khÃ´ng xÃ¡c Ä‘á»‹nh tá»« server');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  const data = await res.json();
                
                // --- (Sá»¬A) Báº¯t Ä‘áº§u thay Ä‘á»•i ---

                // 1. Váº½ anime gá»‘c LÃŠN TRÃŠN CÃ™NG
                await drawSourceAnimeInfo(data.source_anime);
                // (THÃŠM Má»šI) Láº¥y nÄƒm cá»§a anime gá»‘c
                const sourceYear = data.source_anime.year;
Â  Â  Â  Â  Â  Â  Â  Â  // 2. Váº½ biá»ƒu Ä‘á»“ vÃ  grid
Â  Â  Â  Â  Â  Â  Â  Â  drawRecommendChart(data.chart_data);
Â  Â  Â  Â  Â  Â  Â  Â  drawAnimeGrid_F4_Kitsu(data.grid_data, 'grid-recommend', sourceYear);
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  contentDiv.style.display = 'block'; // Hiá»ƒn thá»‹ káº¿t quáº£ (chart + grid)
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  } catch(e) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Lá»—i khi láº¥y gá»£i Ã½ F4:", e);
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('chart-recommend').innerHTML = `<p style='color: red; text-align: center;'>Lá»—i: ${e.message}</p>`;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('grid-recommend').innerHTML = ''; 
                // (Sá»¬A) Váº«n hiá»ƒn thá»‹ contentDiv Ä‘á»ƒ tháº¥y lá»—i
Â  Â  Â  Â  Â  Â  Â  Â  contentDiv.style.display = 'block'; 
Â  Â  Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  Â  Â  loadingDiv.style.display = 'none';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

// (THAY THáº¾ TOÃ€N Bá»˜ HÃ€M NÃ€Y)
function drawRecommendChart(chartData) {
    /** Váº½ biá»ƒu Ä‘á»“ trÃ²n Top 5 gá»£i Ã½ */
    Highcharts.chart('chart-recommend', {
        
        // 1. Sá»­a loáº¡i biá»ƒu Ä‘á»“
        chart: {
            type: 'pie' 
        },
        
        title: {
            text: 'Top 5 Anime TÆ°Æ¡ng Ä‘á»“ng nháº¥t'
        },

        // 2. Sá»­a Tooltip (Ä‘á»ƒ hiá»ƒn thá»‹ % vÃ  Ä‘iá»ƒm)
        tooltip: {
            pointFormat: '<b>{point.name}</b>: {point.y:.4f} <b>({point.percentage:.1f}%)</b>'
        },

        // 3. ThÃªm PlotOptions (quan trá»ng cho biá»ƒu Ä‘á»“ trÃ²n)
        plotOptions: {
            pie: {
                allowPointSelect: true,
                cursor: 'pointer',
                dataLabels: {
                    enabled: true,
                    // Hiá»ƒn thá»‹ tÃªn anime lÃªn cÃ¡c "miáº¿ng bÃ¡nh"
                    format: '<b>{point.name}</b>', 
                    distance: -50 // Äáº·t nhÃ£n bÃªn trong
                },
                showInLegend: false // KhÃ´ng cáº§n hiá»ƒn thá»‹ chÃº thÃ­ch bÃªn dÆ°á»›i
            }
        },

        // 4. Sá»­a Series (Ä‘á»‹nh dáº¡ng cho pie chart)
        series: [{
            name: 'Äá»™ tÆ°Æ¡ng Ä‘á»“ng',
            colorByPoint: true,
            // Dá»¯ liá»‡u chartData cá»§a báº¡n Ä‘Ã£ á»Ÿ Ä‘Ãºng Ä‘á»‹nh dáº¡ng
            // [{name: '...', y: 0.8}, {name: '...', y: 0.7}]
            data: chartData
        }]
        
        // 5. xAxis, yAxis, vÃ  legend cÅ© Ä‘Ã£ bá»‹ xÃ³a
    });
}

// (THÃŠM Má»šI) HÃ m váº½ thÃ´ng tin anime gá»‘c
async function drawSourceAnimeInfo(anime) {
    const container = document.getElementById('f4-source-container');
    container.innerHTML = '<h3>TÃ¬m kiáº¿m cho:</h3>'; // ThÃªm tiÃªu Ä‘á»
    
    // 1. Láº¥y áº£nh tá»« Jikan (chá»‰ 1 áº£nh nÃªn khÃ´ng cáº§n sleep)
    let imageUrl = `https://via.placeholder.com/150x190/667?text=${encodeURIComponent(anime.title.substring(0, 15))}`;
    try {
        const res = await fetch(`https://api.jikan.moe/v4/anime?q=${encodeURIComponent(anime.title)}&limit=1`);
        const jikanData = await res.json();
        if (jikanData.data && jikanData.data.length > 0 && jikanData.data[0].images.jpg.image_url) {
            imageUrl = jikanData.data[0].images.jpg.image_url;
        }
    } catch (e) {
        console.error("Lá»—i táº£i áº£nh anime gá»‘c", e);
    }
    
    // 2. Táº¡o HTML (giá»‘ng áº£nh báº¡n gá»­i)
    // ChÃºng ta dÃ¹ng flexbox Ä‘á»ƒ xáº¿p áº£nh vÃ  thÃ´ng tin cáº¡nh nhau
    container.innerHTML += `
        <div style="display: flex; gap: 20px; background: #f9f9f9; padding: 15px; border-radius: 5px;">
            <div style="flex-shrink: 0;">
                <img src="${imageUrl}" alt="${anime.title}" style="width: 130px; height: 190px; object-fit: cover; border-radius: 5px;">
            </div>
            <div style="color: #333;">
                <h2 style="margin: 0 0 10px 0;">${anime.title}</h2>
                <p style="margin: 5px 0; font-size: 1.1em;">
                    ${anime.year} | ${anime.studios}
                </p>
                <p style="margin: 5px 0; font-size: 1.1em;">
                    <b>Score: ${anime.score}</b>
                </p>
                <p style="margin: 10px 0; color: #555;">
                    ${anime.genres}
                </p>
            </div>
        </div>
        <hr style="margin-top: 30px;">
    `;
    
    // 3. Hiá»ƒn thá»‹
    container.style.display = 'block';
}

// (THAY THáº¾) HÃ€M Váº¼ GRID CHO F1 (DÃ¹ng Kitsu)
async function drawAnimeGrid_F1_Kitsu(animeList, gridId) {
    if (isKitsuLoading) { // <-- Sá»­a khÃ³a
        alert("TÃ­nh nÄƒng F1/F4 (Kitsu) Ä‘ang táº£i, vui lÃ²ng Ä‘á»£i...");
        return;
    }
    isKitsuLoading = true; // <-- Sá»­a khÃ³a

    const grid = document.getElementById(gridId);
    grid.innerHTML = ''; 
    if (animeList.length === 0) {
        grid.innerHTML = 'KhÃ´ng tÃ¬m tháº¥y anime nÃ o.';
        isKitsuLoading = false; // <-- Sá»­a khÃ³a
        return;
    }

    try {
        const itemsToShow = animeList.slice(0, 10); 

        for (const anime of itemsToShow) {
            const card = document.createElement('div');
            card.className = 'anime-card';
            
            // Tooltip ÄÆ N GIáº¢N
            card.innerHTML = `
                <img src="" alt="Äang táº£i..." data-title="${anime.title}">
                <p class="anime-title">${anime.title}</p>
                <div class="info-tooltip">
                    <b>${anime.title}</b>
                    <p>${anime.year} | ${anime.studios}</p>
                    <p>Score: ${anime.score}</p>
                    <p style="color: #ddd;">${anime.genres}</p>
                </div>
            `;
            
            grid.appendChild(card);
            const img = card.querySelector('img');
            const placeholderImg = `https://via.placeholder.com/150x190/667?text=${encodeURIComponent(anime.title.substring(0, 15))}`;

            // (Sá»¬A) Logic táº£i áº£nh Kitsu (sleep 300)
            await sleep(300); 
            
            try {
                const res = await fetch(`https://kitsu.io/api/edge/anime?filter[text]=${encodeURIComponent(anime.title)}&page[limit]=1`, {
                    headers: { 'Accept': 'application/vnd.api+json' }
                });
                const kitsuData = await res.json();
                
                let imageUrl = null;
                if (kitsuData.data && kitsuData.data.length > 0) {
                    imageUrl = kitsuData.data[0].attributes.posterImage.small;
                }

                if (imageUrl) {
                    img.src = imageUrl;
                    img.alt = anime.title;
                } else {
                    img.src = placeholderImg;
                    img.alt = 'KhÃ´ng tÃ¬m tháº¥y áº£nh';
                }
            } catch (e) {
                img.src = placeholderImg;
                img.alt = 'Lá»—i táº£i áº£nh';
            }
        } // Háº¿t vÃ²ng láº·p
    } finally {
        isKitsuLoading = false; // <-- Sá»­a khÃ³a
    }
}

// (THAY THáº¾) HÃ€M Váº¼ GRID CHO F2 (DÃ¹ng Jikan)
async function drawAnimeGrid_F2_Jikan(animeList, gridId) {
    if (isJikanLoading) { // <-- Sá»­a khÃ³a
        alert("TÃ­nh nÄƒng 2 (Jikan) Ä‘ang táº£i, vui lÃ²ng Ä‘á»£i!");
        return;
    }

    const grid = document.getElementById(gridId);
    grid.innerHTML = ''; 
    if (animeList.length === 0) {
        grid.innerHTML = 'KhÃ´ng tÃ¬m tháº¥y anime nÃ o.';
        isJikanLoading = false; // <-- Sá»­a khÃ³a
        return;
    }

    isJikanLoading = true; // <-- Sá»­a khÃ³a
    
    try {
        const itemsToShow = animeList.slice(0, 50);

        for (const anime of itemsToShow) {
            const card = document.createElement('div');
            card.className = 'anime-card';
            
            // Tooltip ÄÆ N GIáº¢N
            card.innerHTML = `
                <img src="" alt="Äang táº£i..." data-title="${anime.title}">
                <p class="anime-title">${anime.title}</p>
                <div class="info-tooltip">
                    <b>${anime.title}</b>
                    <p>${anime.year} | ${anime.studios}</p>
                    <p>Score: ${anime.score}</p>
                    <p style="color: #ddd;">${anime.genres}</p>
                </div>
            `;
            
            grid.appendChild(card);
            
            const img = card.querySelector('img');
            const placeholderImg = `https://via.placeholder.com/150x190/667?text=${encodeURIComponent(anime.title.substring(0, 15))}`;

            // (Sá»¬A) Logic táº£i áº£nh Jikan (sleep 1200)
            await sleep(1200); 
            
            try {
                const res = await fetch(`https://api.jikan.moe/v4/anime?q=${encodeURIComponent(anime.title)}&limit=1`);
                const jikanData = await res.json();
                
                let imageUrl = null;
                if (jikanData.data && jikanData.data.length > 0) {
                    imageUrl = jikanData.data[0].images.jpg.image_url;
                }

                if (imageUrl) {
                    img.src = imageUrl;
                    img.alt = anime.title;
                } else {
                    img.src = placeholderImg;
                    img.alt = 'KhÃ´ng tÃ¬m tháº¥y áº£nh';
                }
            } catch (e) {
                img.src = placeholderImg;
                img.alt = 'Lá»—i táº£i áº£nh';
            }
        } // Háº¿t vÃ²ng láº·p
    } finally {
        isJikanLoading = false; // <-- Sá»­a khÃ³a
    }
}

// (THAY THáº¾) HÃ€M Váº¼ GRID CHO F4 (DÃ¹ng Kitsu)
async function drawAnimeGrid_F4_Kitsu(animeList, gridId, sourceYear) {
    if (isKitsuLoading) { // <-- Sá»­a khÃ³a
        alert("TÃ­nh nÄƒng F1/F4 (Kitsu) Ä‘ang táº£i, vui lÃ²ng Ä‘á»£i!");
        return;
    }
    
    const grid = document.getElementById(gridId);
    grid.innerHTML = ''; 
    if (animeList.length === 0) {
        grid.innerHTML = 'KhÃ´ng tÃ¬m tháº¥y anime nÃ o.';
        isKitsuLoading = false; // <-- Sá»­a khÃ³a
        return;
    }

    isKitsuLoading = true; // <-- Sá»­a khÃ³a
    
    try {
        const itemsToShow = animeList.slice(0, 50);

        for (const anime of itemsToShow) {
            const card = document.createElement('div');
            card.className = 'anime-card';
            
            // --- XÃ¢y dá»±ng Tooltip (Logic nÃ y giá»¯ nguyÃªn) ---
            const final_score = (anime.similarity_score || 0).toFixed(4);
            const score_nlp = anime.score_nlp || 0;
            const matching_keywords = anime.matching_keywords || [];
            const matching_genres = anime.matching_genres || "";
            const matching_studio = anime.matching_studio || "";
            // (THÃŠM Má»šI)
            const score_year = anime.score_year || 0;
            const year_diff = Math.abs(anime.year - sourceYear);

            let nlp_reason = "";
            if (score_nlp >= 0.7) nlp_reason = `<li>â­ Cá»‘t truyá»‡n/Bá»‘i cáº£nh ráº¥t tÆ°Æ¡ng Ä‘á»“ng (Äiá»ƒm: ${score_nlp})</li>`;
            else if (score_nlp >= 0.4) nlp_reason = `<li>âœ”ï¸ Chá»§ Ä‘á»/Bá»‘i cáº£nh khÃ¡ tÆ°Æ¡ng Ä‘á»“ng (Äiá»ƒm: ${score_nlp})</li>`;
            else if (score_nlp >= 0.2) nlp_reason = `<li>âœ”ï¸ CÃ³ má»™t vÃ i nÃ©t tÆ°Æ¡ng Ä‘á»“ng (Äiá»ƒm: ${score_nlp})</li>`;

            let keywords_reason = "";
            if (matching_keywords.length > 0) keywords_reason = `<li>ğŸ”‘ Tá»« khÃ³a chung: ${matching_keywords.join(', ')}</li>`;
            let studio_reason = "";
            if (matching_studio) studio_reason = `<li>âœ”ï¸ CÃ¹ng sáº£n xuáº¥t bá»Ÿi ${matching_studio}</li>`;
            let genre_reason = "";
            if (matching_genres) genre_reason = `<li>âœ”ï¸ CÃ¹ng thá»ƒ loáº¡i: ${matching_genres}</li>`;
            // 6. (THÃŠM Má»šI) Táº¡o lÃ½ do cho NÄƒm
            let year_reason = "";
            if (score_year >= 0.8 && year_diff <= 3) { // Ráº¥t gáº§n (vÃ­ dá»¥: trong 3 nÄƒm)
                year_reason = `<li>âœ”ï¸ Ra máº¯t tÆ°Æ¡ng Ä‘á»‘i gáº§n (cÃ¡ch ${year_diff} nÄƒm)</li>`;
            } else if (score_year >= 0.5) { // TÆ°Æ¡ng Ä‘á»‘i gáº§n
                year_reason = `<li>âœ”ï¸ Ra máº¯t cÃ¡ch ${year_diff} nÄƒm</li>`;
            }
            card.innerHTML = `
                <img src="" alt="Äang táº£i..." data-title="${anime.title}">
                <p class="anime-title">${anime.title}</p>
                <div class="info-tooltip">
                    <b>${anime.title}</b>
                    <p style="color: #FFD700; font-weight: bold; background: #222; padding: 2px 4px; border-radius: 3px; margin: 5px 0;">
                        Äiá»ƒm tÆ°Æ¡ng Ä‘á»“ng: ${final_score}
                    </p>
                    <p style="margin-top: 5px; margin-bottom: 0;"><b>LÃ½ do gá»£i Ã½:</b></p>
                    <ul style="margin: 0; padding-left: 20px; font-size: 0.95em; list-style-type: none;">
                        ${nlp_reason}${keywords_reason}${studio_reason}${genre_reason}${year_reason}
                    </ul>
                    <hr style="border-color: #555; margin: 5px 0;">
                    <p style="font-size: 0.9em; color: #ccc; margin: 0;">${anime.year} | ${anime.studios}</p>
                    <p style="font-size: 0.9em; color: #ccc; margin: 0;">Score gá»‘c: ${anime.score}</p>
                    <p style="font-size: 0.8em; color: #999; margin: 0;">Thá»ƒ loáº¡i gá»‘c: ${anime.genres}</p>
                </div>
            `;
            // --- Háº¾T TOOLTIP ---
            
            grid.appendChild(card);
            
            const img = card.querySelector('img');
            const placeholderImg = `https://via.placeholder.com/150x190/667?text=${encodeURIComponent(anime.title.substring(0, 15))}`;

            // --- (Sá»¬A) LOGIC Táº¢I áº¢NH (DÃ¹ng Kitsu) ---
            await sleep(300); // Kitsu nhanh, chá»‰ cáº§n sleep 300ms
            
            try {
                const res = await fetch(`https://kitsu.io/api/edge/anime?filter[text]=${encodeURIComponent(anime.title)}&page[limit]=1`, {
                    headers: { 'Accept': 'application/vnd.api+json' }
                });
                const kitsuData = await res.json();
                
                let imageUrl = null;
                if (kitsuData.data && kitsuData.data.length > 0) {
                    imageUrl = kitsuData.data[0].attributes.posterImage.small;
                }

                if (imageUrl) {
                    img.src = imageUrl;
                    img.alt = anime.title;
                } else {
                    img.src = placeholderImg;
                    img.alt = 'KhÃ´ng tÃ¬m tháº¥y áº£nh';
                }
            } catch (e) {
                img.src = placeholderImg;
                img.alt = 'Lá»—i táº£i áº£nh';
            }
            // --- Háº¾T Sá»¬A ---

        } // Háº¿t vÃ²ng láº·p
    } finally {
        // (Sá»¬A) Má»Ÿ khÃ³a Kitsu
        isKitsuLoading = false;
    }
}
        </script>
</body>
</html>
